/*
Copyright 2025 Supabase, Inc.

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
*/

// This file contains the RPC service definition for multipooler.

syntax = "proto3";

package multipoolerservice;

import "clustermetadata.proto";
import "mtrpc.proto";
import "query.proto";

option go_package = "github.com/multigres/multigres/go/pb/multipoolerservice";

// MultiPoolerService provides connection pooling and query execution
service MultiPoolerService {
  // ExecuteQuery executes a SQL query and returns the result
  // This should be used sparingly only when we know the result set is small,
  // otherwise StreamExecute should be used.
  rpc ExecuteQuery(ExecuteQueryRequest) returns (ExecuteQueryResponse);

  // StreamExecute executes a SQL query and streams the results back
  rpc StreamExecute(StreamExecuteRequest) returns (stream StreamExecuteResponse);

  // PortalStreamExecute executes a portal (bound prepared statement) and streams results
  // Returns reserved connection information for session affinity
  rpc PortalStreamExecute(PortalStreamExecuteRequest) returns (stream PortalStreamExecuteResponse);

  // Describe returns metadata about a prepared statement or portal
  rpc Describe(DescribeRequest) returns (DescribeResponse);

  // GetAuthCredentials retrieves authentication credentials for a user.
  // Used by multigateway to get SCRAM password hashes for client authentication.
  rpc GetAuthCredentials(GetAuthCredentialsRequest) returns (GetAuthCredentialsResponse);
}

// ExecuteQueryRequest represents a request to execute a SQL query
message ExecuteQueryRequest {
  string query = 1;

  // target specifies the routing destination (tablegroup, shard, pooler type)
  query.Target target = 2;

  uint64 max_rows = 3;

  // caller_id identifies the caller. This is the effective caller ID,
  // set by the application to further identify the caller.
  mtrpc.CallerID caller_id = 4;

  // options contains execution options including session state needed for query execution.
  query.ExecuteOptions options = 5;
}

// ExecuteQueryResponse represents the response from executing a SQL query
message ExecuteQueryResponse {
  query.QueryResult result = 1;
}

// StreamExecuteRequest represents a request to execute a SQL query with streaming results
message StreamExecuteRequest {
  // query is the SQL query to execute
  string query = 1;

  // target specifies the routing destination (tablegroup, shard, pooler type)
  query.Target target = 2;

  // caller_id identifies the caller. This is the effective caller ID,
  // set by the application to further identify the caller.
  mtrpc.CallerID caller_id = 3;

  // options contains execution options including session state needed for query execution.
  query.ExecuteOptions options = 4;
}

// StreamExecuteResponse represents a single response in the stream of query results
message StreamExecuteResponse {
  // result contains the query result data (rows, fields, etc.)
  query.QueryResult result = 1;
}

// PortalStreamExecuteRequest represents a request to execute a portal with streaming results
message PortalStreamExecuteRequest {
  // target specifies the routing destination (tablegroup, shard, pooler type)
  query.Target target = 1;

  // prepared_statement contains the prepared statement to execute
  query.PreparedStatement prepared_statement = 2;

  // portal contains the portal with bound parameters
  query.Portal portal = 3;

  // caller_id identifies the caller
  mtrpc.CallerID caller_id = 4;

  // options contains execution options including max rows and reserved connection ID
  query.ExecuteOptions options = 5;
}

// PortalStreamExecuteResponse represents a response in the portal execution stream
message PortalStreamExecuteResponse {
  // result contains the query result data (rows, fields, etc.)
  query.QueryResult result = 1;

  // reserved_connection_id is the ID of the reserved connection
  // This is returned in the first response and should be used for subsequent queries
  uint64 reserved_connection_id = 2;

  // pooler_id identifies which multipooler instance owns the reserved connection
  clustermetadata.ID pooler_id = 3;
}

// DescribeRequest represents a request to describe a prepared statement or portal
message DescribeRequest {
  // target specifies the routing destination (tablegroup, shard, pooler type)
  query.Target target = 1;

  // prepared_statement is the prepared statement to describe (nil if describing a portal)
  query.PreparedStatement prepared_statement = 2;

  // portal is the portal to describe (nil if describing a prepared statement)
  query.Portal portal = 3;

  // caller_id identifies the caller
  mtrpc.CallerID caller_id = 4;

  // options contains execution options including reserved connection ID
  query.ExecuteOptions options = 5;
}

// DescribeResponse represents the response from describing a statement or portal
message DescribeResponse {
  // description contains the statement metadata (fields, parameter types, etc.)
  query.StatementDescription description = 1;
}

// GetAuthCredentialsRequest represents a request to get authentication credentials for a user.
message GetAuthCredentialsRequest {
  // database is the database the user is connecting to.
  string database = 1;

  // username is the PostgreSQL username to authenticate.
  string username = 2;
}

// GetAuthCredentialsResponse represents the response containing authentication credentials.
// Returns codes.NotFound if the user does not exist.
message GetAuthCredentialsResponse {
  // scram_hash is the stored SCRAM-SHA-256 password hash from pg_authid.
  // Format: SCRAM-SHA-256$<iterations>:<salt>$<stored_key>:<server_key>
  // Empty if user exists but has no password set.
  string scram_hash = 1;
}