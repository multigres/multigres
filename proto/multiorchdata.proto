// Copyright 2025 Supabase, Inc.
//
// Licensed under the Apache License, Version 2.0 (the "License");
// you may not use this file except in compliance with the License.
// You may obtain a copy of the License at
//
//     http://www.apache.org/licenses/LICENSE-2.0
//
// Unless required by applicable law or agreed to in writing, software
// distributed under the License is distributed on an "AS IS" BASIS,
// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
// See the License for the specific language governing permissions and
// limitations under the License.

syntax = "proto3";

package multiorchdata;

import "clustermetadata.proto";
import "multipoolermanagerdata.proto";
import "google/protobuf/timestamp.proto";

option go_package = "github.com/multigres/multigres/go/pb/multiorchdata";

// PoolerHealthState represents the runtime state of a MultiPooler instance.
// This is the in-memory representation used by multiorch to track pooler health.
//
// It contains:
// - Core pooler metadata (embedded MultiPooler from topology)
// - Timestamps for staleness detection
// - Health metrics from Status RPC
// - Computed fields for quick access
message PoolerHealthState {
  // Core pooler metadata from topology.
  // This contains: id, database, table_group, shard, key_range, type,
  // serving_status, hostname, port_map.
  clustermetadata.MultiPooler multi_pooler = 1;

  // Computed fields (cached by multiorch)
  bool is_up_to_date = 2;
  bool is_last_check_valid = 3;

  // Timestamps for staleness detection
  google.protobuf.Timestamp last_check_attempted = 4;
  google.protobuf.Timestamp last_check_successful = 5;
  google.protobuf.Timestamp last_seen = 6;

  // Health status from Status RPC (populated after successful health check).
  // This is the type the pooler reports itself as, which may differ from
  // the topology type (multi_pooler.type) if there's a failover in progress
  // or type mismatch.
  clustermetadata.PoolerType pooler_type = 7;

  // Primary-specific status (populated when pooler_type == PRIMARY)
  multipoolermanagerdata.PrimaryStatus primary_status = 8;

  // Replica-specific status (populated when pooler_type == REPLICA)
  multipoolermanagerdata.StandbyReplicationStatus replication_status = 9;
}
