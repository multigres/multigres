// Copyright 2025 Supabase, Inc.
//
// Licensed under the Apache License, Version 2.0 (the "License");
// you may not use this file except in compliance with the License.
// You may obtain a copy of the License at
//
//     http://www.apache.org/licenses/LICENSE-2.0
//
// Unless required by applicable law or agreed to in writing, software
// distributed under the License is distributed on an "AS IS" BASIS,
// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
// See the License for the specific language governing permissions and
// limitations under the License.

syntax = "proto3";

package multipoolermanager;

import "multipoolermanagerdata.proto";

option go_package = "github.com/multigres/multigres/go/pb/multipoolermanager";

// MultiPoolerManager provides management APIs for PostgreSQL connection poolers
service MultiPoolerManager {
  //
  // PG Replication API wrappers.
  //

  // WaitForLSN waits for PostgreSQL server to reach a specific LSN position
  rpc WaitForLSN(multipoolermanagerdata.WaitForLSNRequest) returns (multipoolermanagerdata.WaitForLSNResponse);

  // SetPrimaryConnInfo sets the primary connection info for a standby server
  rpc SetPrimaryConnInfo(multipoolermanagerdata.SetPrimaryConnInfoRequest)
    returns (multipoolermanagerdata.SetPrimaryConnInfoResponse);

  // StartReplication starts WAL replay on standby (calls pg_wal_replay_resume)
  rpc StartReplication(multipoolermanagerdata.StartReplicationRequest)
    returns (multipoolermanagerdata.StartReplicationResponse);

  // StopReplication stops WAL replay on standby (calls pg_wal_replay_pause)
  rpc StopReplication(multipoolermanagerdata.StopReplicationRequest)
    returns (multipoolermanagerdata.StopReplicationResponse);

  // StandbyReplicationStatus gets the current replication status of the standby
  rpc StandbyReplicationStatus(multipoolermanagerdata.StandbyReplicationStatusRequest)
    returns (multipoolermanagerdata.StandbyReplicationStatusResponse);

  // Status gets unified status that works for both PRIMARY and REPLICA poolers
  // The multipooler returns information based on what type it believes itself to be,
  // avoiding disparity between what MultiOrch thinks versus actual state
  rpc Status(multipoolermanagerdata.StatusRequest)
    returns (multipoolermanagerdata.StatusResponse);

  // ResetReplication resets the standby's connection to its primary by clearing primary_conninfo
  // and reloading PostgreSQL configuration. This effectively
  // disconnects the replica from the primary and prevents it from acknowledging commits, making it
  // unavailable for synchronous replication until reconfigured.
  rpc ResetReplication(multipoolermanagerdata.ResetReplicationRequest)
    returns (multipoolermanagerdata.ResetReplicationResponse);

  // ConfigureSynchronousReplication configures PostgreSQL synchronous replication settings
  // including synchronous_commit, synchronous_standby_names, and synchronization method (ANY/FIRST/quorum)
  rpc ConfigureSynchronousReplication(multipoolermanagerdata.ConfigureSynchronousReplicationRequest)
    returns (multipoolermanagerdata.ConfigureSynchronousReplicationResponse);

  // UpdateSynchronousStandbyList updates the synchronous standby list by adding, removing, or replacing members
  rpc UpdateSynchronousStandbyList(multipoolermanagerdata.UpdateSynchronousStandbyListRequest)
    returns (multipoolermanagerdata.UpdateSynchronousStandbyListResponse);

  // PrimaryStatus gets the status of the leader server
  rpc PrimaryStatus(multipoolermanagerdata.PrimaryStatusRequest)
    returns (multipoolermanagerdata.PrimaryStatusResponse);

  // PrimaryPosition gets the current LSN position of the leader
  rpc PrimaryPosition(multipoolermanagerdata.PrimaryPositionRequest)
    returns (multipoolermanagerdata.PrimaryPositionResponse);

  // StopReplicationAndGetStatus stops PostgreSQL replication (replay and/or receiver based on mode)
  // and returns the status
  rpc StopReplicationAndGetStatus(multipoolermanagerdata.StopReplicationAndGetStatusRequest)
    returns (multipoolermanagerdata.StopReplicationAndGetStatusResponse);


  // Multigres HA
  // The following methods are used by MultiOrch to
  // perform HA operations (reparents and failovers)

  // GetDurabilityPolicy retrieves the active durability policy from the local database
  // Used by MultiOrch to query quorum rules via gRPC instead of direct database connection
  rpc GetDurabilityPolicy(multipoolermanagerdata.GetDurabilityPolicyRequest)
    returns (multipoolermanagerdata.GetDurabilityPolicyResponse);

  // CreateDurabilityPolicy creates a new durability policy in the local database
  // Used by MultiOrch to initialize policies via gRPC instead of direct database connection
  rpc CreateDurabilityPolicy(multipoolermanagerdata.CreateDurabilityPolicyRequest)
    returns (multipoolermanagerdata.CreateDurabilityPolicyResponse);

  // ChangeType changes the pooler type (LEADER/FOLLOWER)
  rpc ChangeType(multipoolermanagerdata.ChangeTypeRequest)
    returns (multipoolermanagerdata.ChangeTypeResponse);

  // GetFollowers gets the list of follower servers
  rpc GetFollowers(multipoolermanagerdata.GetFollowersRequest)
    returns (multipoolermanagerdata.GetFollowersResponse);

  // Demote demotes the current leader server
  rpc Demote(multipoolermanagerdata.DemoteRequest)
    returns (multipoolermanagerdata.DemoteResponse);

  // UndoDemote undoes a demotion
  rpc UndoDemote(multipoolermanagerdata.UndoDemoteRequest)
    returns (multipoolermanagerdata.UndoDemoteResponse);

  // DemoteStalePrimary demotes a stale primary that came back after failover
  // by rewinding to the correct primary and restarting as standby
  rpc DemoteStalePrimary(multipoolermanagerdata.DemoteStalePrimaryRequest)
    returns (multipoolermanagerdata.DemoteStalePrimaryResponse);

  // Promote promotes a replica to leader (Multigres-level operation)
  rpc Promote(multipoolermanagerdata.PromoteRequest)
    returns (multipoolermanagerdata.PromoteResponse);

  // State gets the current status of the manager
  rpc State(multipoolermanagerdata.StateRequest)
    returns (multipoolermanagerdata.StateResponse);

  // SetTerm sets the consensus term information. Used by MultiOrch for consensus operations.
  rpc SetTerm(multipoolermanagerdata.SetTermRequest)
    returns (multipoolermanagerdata.SetTermResponse);

  //
  // Shard Initialization APIs
  // The following methods are used by MultiOrch to bootstrap new shards
  //

  // InitializeEmptyPrimary initializes this pooler as an empty primary
  // Used during bootstrap initialization of a new shard
  rpc InitializeEmptyPrimary(multipoolermanagerdata.InitializeEmptyPrimaryRequest)
    returns (multipoolermanagerdata.InitializeEmptyPrimaryResponse);

  //
  // Backup and Restore
  // All of these RPCs perform backups and restores in the context
  // of the datbase, table group and shard this multipooler serves.
  //

  // Backup performs a backup
  rpc Backup(multipoolermanagerdata.BackupRequest)
    returns (multipoolermanagerdata.BackupResponse);

  // RestoreFromBackup restores from a backup
  rpc RestoreFromBackup(multipoolermanagerdata.RestoreFromBackupRequest)
    returns (multipoolermanagerdata.RestoreFromBackupResponse);

  // GetBackups retrieves backup information
  rpc GetBackups(multipoolermanagerdata.GetBackupsRequest)
    returns (multipoolermanagerdata.GetBackupsResponse);

  // GetBackupByJobId queries a backup by its job_id annotation.
  // Returns the backup metadata if found, or nil backup if not.
  rpc GetBackupByJobId(multipoolermanagerdata.GetBackupByJobIdRequest)
      returns (multipoolermanagerdata.GetBackupByJobIdResponse);

  //
  // PgRewind Operations
  //

  // RewindToSource performs pg_rewind to synchronize this server with a source.
  // This is used to repair diverged timelines after failover.
  // The operation stops PostgreSQL, runs pg_rewind, and restarts PostgreSQL.
  rpc RewindToSource(multipoolermanagerdata.RewindToSourceRequest)
      returns (multipoolermanagerdata.RewindToSourceResponse);
  
  //
  // PostgreSQL Monitoring Control
  //
  
  // SetMonitor enables or disables the PostgreSQL monitoring goroutine
  rpc SetMonitor(multipoolermanagerdata.SetMonitorRequest)
        returns (multipoolermanagerdata.SetMonitorResponse);
}
