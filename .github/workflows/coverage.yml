# Copyright 2025 Supabase, Inc.
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

name: Code Coverage

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

permissions: {}

jobs:
  coverage-direct:
    name: Direct test coverage
    runs-on: ubuntu-24.04

    steps:
      - uses: actions/checkout@93cb6efe18208431cddfb8368fd83d5badbf9bfd # v5.0.1
        with:
          persist-credentials: false

      - name: Set up Go
        uses: actions/setup-go@4dc6199c7b1a012772edbd06daecab0f50c9053c # v6.1.0
        with:
          go-version: "1.25.0"

      - name: Set up test environment
        run: .github/scripts/setup-test-environment.sh

      - name: Build
        run: make build

      - name: Run tests with direct coverage
        run: go test -cover -covermode=atomic -coverprofile=coverage-direct.txt -coverpkg=./... ./...

      - name: Upload direct coverage artifact
        uses: actions/upload-artifact@50769540e7f4bd5e21e526ee35c689e35e0d6874 # v4.4.0
        if: always()
        with:
          name: coverage-direct
          path: coverage-direct.txt
          retention-days: 7

  coverage-subprocess:
    name: Subprocess coverage
    runs-on: ubuntu-24.04

    steps:
      - uses: actions/checkout@93cb6efe18208431cddfb8368fd83d5badbf9bfd # v5.0.1
        with:
          persist-credentials: false

      - name: Set up Go
        uses: actions/setup-go@4dc6199c7b1a012772edbd06daecab0f50c9053c # v6.1.0
        with:
          go-version: "1.25.0"

      - name: Set up test environment
        run: .github/scripts/setup-test-environment.sh

      - name: Build coverage binaries
        run: make build-coverage

      - name: Run tests with subprocess coverage
        run: |
          mkdir -p coverage-subprocess-raw
          export GOCOVERDIR="$PWD/coverage-subprocess-raw"
          go test ./...

      - name: Convert subprocess coverage to text format
        run: go tool covdata textfmt -i=coverage-subprocess-raw -o=coverage-subprocess.txt

      - name: Upload subprocess coverage artifact
        uses: actions/upload-artifact@50769540e7f4bd5e21e526ee35c689e35e0d6874 # v4.4.0
        if: always()
        with:
          name: coverage-subprocess
          path: coverage-subprocess.txt
          retention-days: 7

  merge-and-upload:
    name: Merge coverage and upload
    runs-on: ubuntu-24.04
    needs: [coverage-direct, coverage-subprocess]
    if: always()

    steps:
      - uses: actions/checkout@93cb6efe18208431cddfb8368fd83d5badbf9bfd # v5.0.1
        with:
          persist-credentials: false

      - name: Set up Go
        uses: actions/setup-go@4dc6199c7b1a012772edbd06daecab0f50c9053c # v6.1.0
        with:
          go-version: "1.25.0"

      - name: Download direct coverage artifact
        uses: actions/download-artifact@fa0a91b85d4f404e444e00e005971372dc801d16 # v4.1.8
        with:
          name: coverage-direct
          path: ./coverage-artifacts/direct

      - name: Download subprocess coverage artifact
        uses: actions/download-artifact@fa0a91b85d4f404e444e00e005971372dc801d16 # v4.1.8
        with:
          name: coverage-subprocess
          path: ./coverage-artifacts/subprocess

      - name: Merge coverage files
        run: |
          ./scripts/merge-coverage.sh \
            coverage-artifacts/direct/coverage-direct.txt \
            coverage-artifacts/subprocess/coverage-subprocess.txt \
            coverage-merged.txt

          echo ""
          echo "Final coverage summary:"
          go tool cover -func=coverage-merged.txt | tail -1

      - name: Upload merged coverage artifact
        uses: actions/upload-artifact@50769540e7f4bd5e21e526ee35c689e35e0d6874 # v4.4.0
        if: always()
        with:
          name: coverage-merged
          path: coverage-merged.txt
          retention-days: 7

      - name: Upload coverage to Coveralls
        if: success() || failure()
        uses: coverallsapp/github-action@643bc377ffa44ace6394b2b5d0d3950076de9f63 # v2.3.0
        with:
          file: ./coverage-merged.txt
          format: golang

      - name: Upload coverage reports to Codecov
        uses: codecov/codecov-action@5a1091511ad55cbe89839c7260b706298ca349f7 # v5.5.1
        with:
          files: ./coverage-merged.txt
          token: ${{ secrets.CODECOV_TOKEN }}
