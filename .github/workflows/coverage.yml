# Copyright 2025 Supabase, Inc.
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

name: Code Coverage

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

permissions: {}

jobs:
  coverage-direct:
    name: Direct test coverage
    runs-on: ubuntu-24.04

    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          persist-credentials: false

      - name: Set up Go
        uses: actions/setup-go@7a3fe6cf4cb3a834922a1244abfce67bcef6a0c5 # v6.2.0
        with:
          go-version-file: go.mod

      - name: Set up test environment
        run: .github/scripts/setup-test-environment.sh

      - name: Build
        run: make build

      - name: Run tests with direct coverage
        run: go test -json -v -skip TestPostgreSQLRegression -cover -covermode=atomic -coverprofile=coverage-direct.txt -coverpkg=./... ./... | tee coverage-direct-test-results.jsonl | go tool tparse -follow

      - name: Upload direct coverage artifact
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        if: always()
        with:
          name: coverage-direct
          path: coverage-direct.txt
          retention-days: 7

      - name: Test Report
        uses: dorny/test-reporter@fe45e9537387dac839af0d33ba56eed8e24189e8 # v2.3.0
        if: ${{ !cancelled() }}
        with:
          name: Direct Coverage Tests
          path: coverage-direct-test-results.jsonl
          reporter: golang-json

  coverage-subprocess:
    name: Subprocess coverage
    runs-on: ubuntu-24.04

    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          persist-credentials: false

      - name: Set up Go
        uses: actions/setup-go@7a3fe6cf4cb3a834922a1244abfce67bcef6a0c5 # v6.2.0
        with:
          go-version-file: go.mod

      - name: Set up test environment
        run: .github/scripts/setup-test-environment.sh

      - name: Build coverage binaries
        run: make build-coverage

      - name: Run tests with subprocess coverage
        run: |
          mkdir -p coverage-subprocess-raw
          export GOCOVERDIR="$PWD/coverage-subprocess-raw"
          go test -json -v -skip TestPostgreSQLRegression ./... | tee coverage-subprocess-test-results.jsonl | go tool tparse -follow

      - name: Convert subprocess coverage to text format
        run: go tool covdata textfmt -i=coverage-subprocess-raw -o=coverage-subprocess.txt

      - name: Upload subprocess coverage artifact
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        if: always()
        with:
          name: coverage-subprocess
          path: coverage-subprocess.txt
          retention-days: 7

      - name: Test Report
        uses: dorny/test-reporter@fe45e9537387dac839af0d33ba56eed8e24189e8 # v2.3.0
        if: ${{ !cancelled() }}
        with:
          name: Subprocess Coverage Tests
          path: coverage-subprocess-test-results.jsonl
          reporter: golang-json

  merge-and-upload:
    name: Merge coverage and upload
    runs-on: ubuntu-24.04
    needs: [coverage-direct, coverage-subprocess]
    if: always()

    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          persist-credentials: false

      - name: Set up Go
        uses: actions/setup-go@7a3fe6cf4cb3a834922a1244abfce67bcef6a0c5 # v6.2.0
        with:
          go-version-file: go.mod

      - name: Download direct coverage artifact
        uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v7.0.0
        with:
          name: coverage-direct
          path: ./coverage-artifacts/direct

      - name: Download subprocess coverage artifact
        uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v7.0.0
        with:
          name: coverage-subprocess
          path: ./coverage-artifacts/subprocess

      - name: Merge coverage files
        run: |
          ./scripts/merge-coverage.sh \
            coverage-artifacts/direct/coverage-direct.txt \
            coverage-artifacts/subprocess/coverage-subprocess.txt \
            coverage-merged.txt

          echo ""
          echo "Final coverage summary:"
          go tool cover -func=coverage-merged.txt | tail -1

      - name: Upload merged coverage artifact
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        if: always()
        with:
          name: coverage-merged
          path: coverage-merged.txt
          retention-days: 7

      - name: Upload coverage to Coveralls
        if: success() || failure()
        uses: coverallsapp/github-action@648a8eb78e6d50909eff900e4ec85cab4524a45b # v2.3.6
        with:
          file: ./coverage-merged.txt
          format: golang
          parallel: true
          flag-name: merged

  coveralls-finish:
    name: Finish Coveralls upload
    runs-on: ubuntu-24.04
    needs: [coverage-direct, coverage-subprocess, merge-and-upload]
    if: success()

    steps:
      - name: Coveralls Finished
        uses: coverallsapp/github-action@648a8eb78e6d50909eff900e4ec85cab4524a45b # v2.3.6
        with:
          parallel-finished: true
